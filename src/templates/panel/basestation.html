{% extends 'site/content.html' %}
{% load staticfiles %}

{% block extrahead %}
    <style type="text/css">
        .bts-form label {
            width: 140px;
            text-align: right;
            padding: 0px 5px;
        }

        .bts-form label.inline {
            width: auto;
        }

        .cell-formset-container input {
            width: 70px;
        }

        .map {
            width: 650px;
            height: 400px;
            border: 1px solid black;
        }

        #location-selector {
            padding-left: 145px;
            padding-bottom: 10px;
            /*display: none;*/
        }
    </style>
{% endblock extrahead %}

{% block page-title %}
    Panel edycji stacji bazowej
{% endblock page-title %}

{% block content-title %}
    {% if base_station %}
        {{ base_station }} (ID: {{ base_station.id }})
    {% else %}
        Nowa stacja bazowa
    {% endif %}
{% endblock content-title %}

{% block main-content %}

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <form action="" method="post" id="basestation-form" class="bts-form" role="form">
        {% csrf_token %}
        {{ form.non_field_errors }}

        <div>
            <label>ID</label>
            {{ base_station.id }}
        </div>

        {# location #}
        <div>
            {{ form.location.label_tag }}
            <span id="location-info">{{ base_station.location }}</span>
            (ID: <span id="location-id">{{ form.location.value|default_if_none:"" }}</span>) <button id="location-selector-toggler">Otwórz mapę</button><br/>
            {{ form.location }} {{ form.location.errors }}
        </div>

        <div id="location-selector">
            <input type="hidden" id="coords" value="{{ base_station.location_coords }}" />
            <input type="text" id="location-search" placeholder="Szukaj lokalizacji..." />
            <div id="location-map" class="map"></div>
        </div>

        {# location_details #}
        <div>
            {{ form.location_details.label_tag }}
            <input type="text" name="{{ form.location_details.html_name }}" id="{{ form.location_details.id_for_label }}" value="{{ form.location_details.value|default_if_none:"" }}" style="width: 500px;" />
            {{ form.location_details.errors }}
        </div>

        {# network & is_networks #}
        <div>
            {{ form.network.label_tag }}
            {{ form.network }} <label class="inline">{{ form.is_networks }} NetWorks!</label>
            {{ form.network.errors }}
        </div>

        {# station_id & rnc & enbi #}
        <div>
            {{ form.station_id.label_tag }}
            <input type="text" name="{{ form.station_id.html_name }}" id="{{ form.station_id.id_for_label }}" value="{{ form.station_id.value|default_if_none:"" }}" style="width: 80px;" />
            {{ form.station_id.errors }}

            {{ form.rnc.label_tag }}
            <input type="text" name="{{ form.rnc.html_name }}" id="{{ form.rnc.id_for_label }}" value="{{ form.rnc.value|default_if_none:"" }}" style="width: 80px;" />
            {{ form.rnc.errors }}

            {{ form.enbi.label_tag }}
            <input type="text" name="{{ form.enbi.html_name }}" id="{{ form.enbi.id_for_label }}" value="{{ form.enbi.value|default_if_none:"" }}" style="width: 80px;" />
            {{ form.enbi.errors }}
        </div>

        {# flags #}
        <div>
            <label>&nbsp;</label>
            <label class="inline">
                {{ form.is_common_bcch }} Common BCCH
            </label>
            <label class="inline">
                {{ form.is_gsm }} GSM
            </label>
            <label class="inline">
                {{ form.is_umts }} UMTS
            </label>
            <label class="inline">
                {{ form.is_lte }} LTE
            </label>
            <label class="inline">
                {{ form.is_cdma }} CDMA
            </label>
        </div>

        {# station_status & edit_status #}
        <div>
            {{ form.station_status.label_tag }}
            {{ form.station_status }}
            {{ form.station_status.errors }}

            {{ form.edit_status.label_tag }}
            {{ form.edit_status }}
            {{ form.edit_status.errors }}
        </div>

        <div>
            <label>Aktualizacja:</label>
            {{ base_station.date_updated }}
            <label>Data dodania:</label>
            {{ base_station.date_added }}
        </div>

        {% if cell_formset %}
            <h3>Komórki stacji bazowej</h3>

            {{ cell_formset.management_form }}
            {{ cell_formset.non_form_errors }}
            <table>
                <tr>
                    <th>Standard</th>
                    <th>Pasmo</th>
                    <th>Potw.?</th>
                    <th>Nośna</th>
                    <th>LAC</th>
                    <th>CID/CLID</th>
                    <th>LongCID</th>
                    <th>E-CID</th>
                    <th>Notatki</th>
                </tr>
            {% for cell_form in cell_formset  %}
                <tr class="cell-formset-container">
                    <td>
                       {{ cell_form.standard }}
                    </td>
                    <td>
                       {{ cell_form.band }}
                    </td>
                    <td>
                       {{ cell_form.is_confirmed }}
                    </td>
                    <td>
                       {{ cell_form.ua_freq }}
                    </td>
                    <td>
                       {{ cell_form.lac }}
                    </td>
                    <td>
                       <input type="text" name="{{ cell_form.cid.html_name }}" id="{{ cell_form.cid.id_for_label }}" value="{{ cell_form.cid.value }}" title="{{ cell_form.cid.help_text }}" />
                    </td>
                    <td>
                        <input type="text" name="{{ cell_form.cid_long.html_name }}" id="{{ cell_form.cid_long.id_for_label }}" value="{{ cell_form.cid_long.value }}" title="{{ cell_form.cid_long.help_text }}" style="width: 100px;"/>
                    </td>
                    <td>
                       <input type="text" name="{{ cell_form.ecid.html_name }}" id="{{ cell_form.ecid.id_for_label }}" value="{{ cell_form.ecid.value }}" title="{{ cell_form.ecid.help_text }}" style="width: 100px;"/>
                    </td>
                    <td>
                        <input type="text" name="{{ cell_form.notes.html_name }}" id="{{ cell_form.notes.id_for_label }}" value="{% if cell_form.notes.value %}{{ cell_form.notes.value }}{% endif %}" style="width: 150px;"/>
                        {{ cell_form.id }}
                        {{ cell_form.base_station }}
                        {{ cell_form.DELETE }}
                    </td>
                </tr>
            {% endfor %}
            </table>
        {% endif %}

        <input type="submit" value="Zachowaj" class="btn btn-primary btn-lg pull-right" />
    </form>

{% endblock main-content %}

{% block extrascripts %}
    <script type="text/javascript" src="{% static 'libs/jquery.formset.js' %}"></script>
    <script type="text/javascript">
        $(function() {

            var attachCellChangeEvent = function() {
                $('select[name*=standard]').on('change', function(e){
                    var std = $(this).val();
                    var idx = $(this).attr('name').split('-')[1];
                    if (std == 'GSM') {
                        $('#id_cells-'+idx+'-cid_long').attr('disabled', true);
                        $('#id_cells-'+idx+'-ecid').attr('disabled', true);
                    } else if (std == 'UMTS') {
                        $('#id_cells-'+idx+'-cid_long').attr('disabled', false);
                        $('#id_cells-'+idx+'-ecid').attr('disabled', true);
                    } else if (std == 'LTE') {
                        $('#id_cells-'+idx+'-cid_long').attr('disabled', true);
                        $('#id_cells-'+idx+'-ecid').attr('disabled', false);
                    }
                });

                $("input[name$='-cid']").on('keyup', function(e){
                    var idx = $(this).attr('name').split('-')[1];
                    var std = $('#id_cells-'+idx+'-standard').val();
                    var rnc = parseInt($('#id_rnc').val());
                    var enbi = parseInt($('#id_enbi').val());
                    var cid = parseInt($(this).val());
                    if (std == 'UMTS' && rnc > 0) {
                        longcid = rnc * 65536 + cid;
                        $('#id_cells-'+idx+'-cid_long').val(longcid);
                    }
                    if (std == 'LTE' && enbi > 0) {
                        ecid = enbi * 256 + cid;
                        $('#id_cells-'+idx+'-ecid').val(ecid);
                    }
                });

                $("input[name$='-cid_long']").on('keyup', function(e){
                    var idx = $(this).attr('name').split('-')[1];
                    var std = $('#id_cells-'+idx+'-standard').val();
                    if (std == 'UMTS') {
                        var longcid = parseInt($(this).val());
                        var rnc = parseInt(longcid / 65536);
                        var cid = longcid % 65536;
                        $('#id_rnc').val(rnc);
                        $('#id_cells-'+idx+'-cid').val(cid);
                    }
                });

                $("input[name$='-ecid']").on('keyup', function(e){
                    var idx = $(this).attr('name').split('-')[1];
                    var std = $('#id_cells-'+idx+'-standard').val();
                    if (std == 'LTE') {
                        var ecid = parseInt($('#id_cells-'+idx+'-ecid').val());
                        var enbi = parseInt(ecid / 256);
                        var cid = ecid % 256;
                        $('#id_enbi').val(enbi);
                        $('#id_cells-'+idx+'-cid').val(cid);
                    }
                });

                // $('select[name*=band]').on('change', function(e){
                //     var std = $(this).val();
                //     var idx = $(this).attr('name').split('-')[1];
                // });
            };

            $('.cell-formset-container').formset({
                prefix: '{{ cell_formset.prefix }}',
                keepFieldValues: 'input',
                added: attachCellChangeEvent(),
                removed: attachCellChangeEvent(),
                addText: 'dodaj',
                deleteText: 'usuń'
            });

            $('#location-selector-toggler').on('click', function(e){
                $('#location-selector').show();
                $('#location-selector-toggler').hide();
                e.preventDefault();
            });

            $('input[name*=cells]').each(function(){

            });

        });
    </script>

    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&amp;libraries=places"></script>
    <script type="text/javascript">
        $(function(){

            var map = null;
            var markers = [];
            var selectedIcon = "http://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=|ff0000|000000";
            var currentIcon = "http://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=|00ff00|000000";
            var normalIcon = "http://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=|ff776b|000000";
            var currentMarker;
            var selectedMarker = -1;
            var currentLocationId = $('#id_location').val();
            var selectedLocationId = -1;

            var handleMarkerClick = function(i, id) {
                google.maps.event.addListener(markers[i], 'click', function(){
                    if (currentMarker != i) {
                        if (selectedMarker >- 1) {
                            markers[selectedMarker].setIcon(normalIcon);
                        }
                        selectedMarker = i;
                        selectedLocationId = id;
                        markers[i].setIcon(selectedIcon);
                        var url = '/map/locations/' + id;
                        $.getJSON(url, function(data){
                            $('#location-info').html(data.summary);
                            $('#location-id').html(data.id);
                            $('#id_location').val(data.id);
                        });
                    }
                });
            };

            var clearMap = function() {
                for (var i in markers) markers[i].setMap(null)
            };

            var getLocations = function() {
                var url = "/map/locations/?bounds=" + map.getBounds().toUrlValue();
                $.getJSON(url, function(data){
                    clearMap();
                    data = data.objects;
                    for (var i in data) {
                        var icon = normalIcon;
                        var locationId = data[i].id;
                        if (locationId == currentLocationId) {
                            icon = currentIcon;
                            currentMarker = i;
                        }
                        if (locationId == selectedLocationId) {
                            icon = selectedIcon;
                            selectedMarker = i;
                        }
                        markers[i] = new google.maps.Marker({
                            position: new google.maps.LatLng(data[i].latitude, data[i].longitude),
                            icon: icon,
                            map: map
                        });
                        handleMarkerClick(i, locationId);
                    }
                });
            };

            var getInitLatLng = function() {
                var currentCoords = $('#coords').val();
                var coords = null;
                if (currentCoords) {
                    coords = currentCoords.split(',');
                } else {
                    coords = [52.069245, 19.480193]
                }
                return new google.maps.LatLng(coords[0],coords[1]);
            };

            var searchLocation = function(query) {
                var geocoder = new google.maps.Geocoder();
                var params = {
                    'address': query,
                    'region': 'pl'
                };
                geocoder.geocode(params, function(results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {
                        map.setCenter(new google.maps.LatLng(
                            results[0].geometry.location.lat(),
                            results[0].geometry.location.lng()
                        ));
                    }
                });
            };

            var initParams = {
                zoom: 15,
                center: getInitLatLng(),
                streetViewControl: false,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };

            // Instantiate map object
            map = new google.maps.Map(document.getElementById("location-map"), initParams);

            // Attach event
            google.maps.event.addListener(map, 'idle', function() {
                if (map.getZoom() >= 11) {
                    getLocations();
                } else {
                    clearMap();
                }
            });

            $('#location-search').on('keypress', function(e){
                if (e.which == 13) {
                    searchLocation($(this).val());
                    e.preventDefault();
                }
            });

            searchBox = document.getElementById('location-search');
            autocomplete = new google.maps.places.Autocomplete(searchBox);
            autocomplete.bindTo('bounds', map);

            setTimeout(function(){
                $('#location-selector').hide();
            }, 1500);

        });
    </script>

{% endblock extrascripts %}